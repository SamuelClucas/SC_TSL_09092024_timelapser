<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Main.py Overview</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="main_files/libs/clipboard/clipboard.min.js"></script>
<script src="main_files/libs/quarto-html/quarto.js"></script>
<script src="main_files/libs/quarto-html/popper.min.js"></script>
<script src="main_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="main_files/libs/quarto-html/anchor.min.js"></script>
<link href="main_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="main_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="main_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="main_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="main_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Main.py Overview</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><strong>Something to note:</strong> the code blocks in these documents will not successfully execute, simply because the libraries used (neopixel, picamera2, libcamera) are designed to be installed and run on embedded systems like the raspberry pi. Ignore the errors. Also, any modifications to be made to the code (<strong>in this format</strong>) will be implemented and tested after the initial ‘over-the-weekend’ timelapse is complete, as I do not want to interrupt it by connecting to the pi.</p>
<p>Also, if using your own virtual enivronment and not ‘camera’ provided within the project repository, make sure you enable –system-site-packages. Libcamera must be installed system wide. See the <a href="https://datasheets.raspberrypi.com/camera/picamera2-manual.pdf">documentation</a>. If using camera, cd to the project directory and input “source camera/bin/activate”. If successful, you should see <em>(camera)</em> appear as below:</p>
<pre class="{bash}"><code>raspberrypi@raspberrypi:~/Desktop $ source camera/bin/activate
(camera) raspberrypi@raspberrypi:~/Desktop $</code></pre>
<p><em>Listing 1</em> imports the relevant python libraries for the project. Firstly I import custom project classes NeopixelController (to control the LED ring) CameraController, and MotorController. For example, the first line imports the CameraController class from src/camera/camera_controller.py. The <strong>init</strong>.py in src/camera (and indeed all the custom classes imported in the project) explicitly defines files as packages, allowing the use of their namespace in the root program ‘main.py’. This is not required by python anymore but has been included for clarity when understanding the project’s structure. <a href="src/map.md">See</a> for a markdown schematic outlining the project’s structure to get comfortable with the OOP notation used in src/main.py.</p>
<div id="69b80dbb" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> camera.camera_controller <span class="im">import</span> CameraController</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lighting.neopixel_controller <span class="im">import</span> NeopixelController</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> motor.motor_controller <span class="im">import</span> MotorController</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys, os</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> picamera2 <span class="im">import</span> Picamera2, Preview</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> libcamera <span class="im">import</span> controls</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ModuleNotFoundError</span>                       Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[17], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> <span style="font-weight:bold;color:rgb(0,135,0)">from</span> <span style="font-weight:bold;color:rgb(0,0,255)">camera</span><span style="font-weight:bold;color:rgb(0,0,255)">.</span><span style="font-weight:bold;color:rgb(0,0,255)">camera_controller</span> <span style="font-weight:bold;color:rgb(0,135,0)">import</span> CameraController
<span class="ansi-green-fg ansi-bold">      2</span> <span style="font-weight:bold;color:rgb(0,135,0)">from</span> <span style="font-weight:bold;color:rgb(0,0,255)">lighting</span><span style="font-weight:bold;color:rgb(0,0,255)">.</span><span style="font-weight:bold;color:rgb(0,0,255)">neopixel_controller</span> <span style="font-weight:bold;color:rgb(0,135,0)">import</span> NeopixelController
<span class="ansi-green-fg ansi-bold">      3</span> <span style="font-weight:bold;color:rgb(0,135,0)">from</span> <span style="font-weight:bold;color:rgb(0,0,255)">motor</span><span style="font-weight:bold;color:rgb(0,0,255)">.</span><span style="font-weight:bold;color:rgb(0,0,255)">motor_controller</span> <span style="font-weight:bold;color:rgb(0,135,0)">import</span> MotorController

<span class="ansi-red-fg">ModuleNotFoundError</span>: No module named 'camera'</pre>
</div>
</div>
</div>
<p><em>Listing 1</em>: Importing relevant libraries, where the first three imports are custom classes written specifically for this project.</p>
<p><em>Listing 2</em> is an initial implementation of the ImagingSystem class is defined followed by creating an object instancei in the main body code. This should be considered the ‘root’ of the programme. Its purpose is to instigate, coordinate, and terminate the operation of the system. As the system grows in complexity, this will act as a control centre.</p>
<div id="152f6b41" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ImagingSystem:</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parser <span class="op">=</span> argparse.ArgumentParser(</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>            prog<span class="op">=</span><span class="st">'ImagingSystem'</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>            description<span class="op">=</span><span class="st">'Operator for the imaging system'</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> timelapse(<span class="va">self</span>):</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> cleanup(<span class="va">self</span>):</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>system <span class="op">=</span> ImagingSystem()</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>system.timelapse()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[18], line 14</span>
<span class="ansi-green-fg ansi-bold">     11</span>     <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">cleanup</span>(<span style="color:rgb(0,135,0)">self</span>):
<span class="ansi-green-fg ansi-bold">     12</span>         <span style="font-weight:bold;color:rgb(0,135,0)">pass</span>
<span class="ansi-green-fg">---&gt; 14</span> system <span style="color:rgb(98,98,98)">=</span> ImagingSystem()
<span class="ansi-green-fg ansi-bold">     15</span> system<span style="color:rgb(98,98,98)">.</span>timelapse()

Cell <span class="ansi-green-fg">In[18], line 3</span>, in <span class="ansi-cyan-fg">ImagingSystem.__init__</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">      2</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">__init__</span>(<span style="color:rgb(0,135,0)">self</span>):
<span class="ansi-green-fg">----&gt; 3</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>parser <span style="color:rgb(98,98,98)">=</span> argparse<span style="color:rgb(98,98,98)">.</span>ArgumentParser(
<span class="ansi-green-fg ansi-bold">      4</span>         prog<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">ImagingSystem</span><span style="color:rgb(175,0,0)">'</span>,
<span class="ansi-green-fg ansi-bold">      5</span>         description<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">Operator for the imaging system</span><span style="color:rgb(175,0,0)">'</span>,
<span class="ansi-green-fg ansi-bold">      6</span>     )

<span class="ansi-red-fg">NameError</span>: name 'argparse' is not defined</pre>
</div>
</div>
</div>
<p><em>Listing 2</em>: Defining the ImagingSystem class, containing: a constructor with an argument parser to facilitate CLI functionality; a ‘timelapse’ function; a ‘cleanup’ function to give an opportunity for the programme to terminate itself cleanly. An instance of the ImagingSystem class ‘system’ is created in the main body, before calling system’s timelapse function. Note that ‘self’ is implicit here with the ‘.’ method notation.</p>
<p>Let’s focus on the constructor ‘<strong>init</strong>(self)’ for now (<em>Listing 3</em>). Using the ‘argparse’ module from listing 1 (<a href="https://docs.python.org/3/library/argparse.html">see documentation here:</a>), arguments are stored in the ‘self.parser’ class member, which is an ArgumentParser object that uses associated’.add_argument()’ method to store command-line inputs as variables in the programme. This allows the user to specify the parameters of their timelapse. For example, if the -n flag is used when running the programme from the command line, self.parser stores “-n <strong>this</strong>” string under the variable name n, which can be accessed in the programme by ‘self.parser.args.name’. Continuing with this example, ‘print(self.parser.args.name)’ would print “this” to standard output.</p>
<p>It should be noted that the logic for each of these CLI arguments hasn’t yet been implemented fully in the programme. Nonetheless they are included, and will likely be used as development continues, or as the system evolves.</p>
<p>For now, instructions will be sent to the imaging system manually through the CLI, but with time the idea is that the programme becomes increasingly autonomous, where the only interaction with the system’s software will occur when offloading experiment data and results.</p>
<div id="c7909b6f" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ImagingSystem:</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parser <span class="op">=</span> argparse.ArgumentParser(</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>            prog<span class="op">=</span><span class="st">'ImagingSystem'</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>            description<span class="op">=</span><span class="st">'Operator for the imaging system'</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        )  </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parser.add_argument(<span class="st">"-t"</span>, <span class="st">"--timelapse"</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Initiate a timelapse. See manual for additional parameters."</span>, action<span class="op">=</span><span class="st">'store_true'</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parser.add_argument(<span class="st">"-u"</span>, <span class="st">"--units"</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"When specifying timelapse parameters, declare the units of time here for clarity. E.g. s for seconds, m for minutes, h for hours, d for days"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parser.set_defaults(u <span class="op">=</span> <span class="st">'s'</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parser.add_argument(<span class="st">"-d"</span>, <span class="st">"--duration"</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Specify the the total time period you want the system to image for. E.g. the CLI input </span><span class="ch">\"</span><span class="st">-u  h -d 4</span><span class="ch">\"</span><span class="st"> will create a 4-hour timelapse. "</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parser.set_defaults(d <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parser.add_argument(<span class="st">"-s"</span>, <span class="st">"--samples"</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Specify at how many timepoints you wish to take an image. E.g. </span><span class="ch">\"</span><span class="st">-i 80</span><span class="ch">\"</span><span class="st"> creates a timelapse with 80 images at evenly spaced timepoints throughout the timelapse"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parser.set_defaults(i <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parser.add_argument(<span class="st">"-p"</span>, <span class="st">"--path"</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Specify a file path to which the timelapse images will be saved. Default = ./</span><span class="ch">\"</span><span class="st">images</span><span class="ch">\"</span><span class="st">"</span>)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parser.set_defaults(p <span class="op">=</span> <span class="st">'images'</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parser.add_argument(<span class="st">"-n"</span>, <span class="st">"--name"</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Unique identifier for your timelapse"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># rest of code...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><em>Listing 3</em>: Declaration of ‘self.parser’ member of the ImagingSystem class, which is an ArgumentParser object defined by the ‘argparse’ library important in <em>Listing 1</em>. As the project develops, these arguments (timelapse, units, duration, samples, path, name) are to be integrated into the programme’s functionality.</p>
<p>Continuing in setting up the class constructor (<em>Listing 4</em>), some additional useful class members are declared.</p>
<p>Firstly, calling the ArgumentParser method .parse_args() on the self.parser member, inputs from the command-line are stored in self.parser under the namespace ‘args’ (hence these arguments can be accessed as described above <em>Listing 2</em>).</p>
<p>Next, the interval at which images are to be taken by the system is calculated by dividing the ‘self.args.duration’ (i.e.&nbsp;the command-line input specifying the duration of timelapse after the -d flag) by the total number of images the user wishes to be taken (‘self.args.samples’). This is stored in the ‘self.interval’ member.</p>
<p>The corresponding date for the timelapse is stored in ‘self.currentDate’ which uses the ‘datetime’ module imported in <em>Listing 1</em> (<a href="https://docs.python.org/3/library/datetime.html">see documentation here:</a>)</p>
<p>Finally self.saveLoc stores the directory to which timelapse images will be saved using the ‘os’ library imported in <em>Listing 1</em> (<a href="https://docs.python.org/3/library/os.html">see documentation here:</a>). For now, this defaults to ‘./images/{self.currentDate}’ (where: ‘./’ means within the project directory; ‘{variable}’ allows you to insert a variable into a string, by using a <a href="https://bic-berkeley.github.io/psych-214-fall-2016/string_literals.html">string literal</a> ” f’string {variable}’ “), or the path can be specified using the ‘-p’ or ‘–path’ flag when running the program in the CLI. This allows the programme to save timelapse images at the specified directory within a folder named the date that the timelapse started in the format day-month-year.</p>
<p><strong>If the -name flag is used, I will add this to ‘self.saveLoc’ to prevent separate timelapses that would have the same path from being saved to the same folder (e.g.&nbsp;when self.parser.args.path and self.parser.args.currentDate are the same for both timelapses).</strong></p>
<div id="420d2150" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ...preceding code</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.args <span class="op">=</span> <span class="va">self</span>.parser.parse_args()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.interval <span class="op">=</span> <span class="va">self</span>.args.duration <span class="op">/</span> <span class="va">self</span>.args.samples</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.currentDate <span class="op">=</span> <span class="bu">str</span>(datetime.datetime.today().strftime(<span class="st">'</span><span class="sc">%d</span><span class="st">-%m-%Y'</span>))</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.saveLoc <span class="op">=</span> os.path.join(<span class="va">self</span>.args.path, <span class="va">self</span>.currentDate)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># rest of code...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[20], line 2</span>
<span class="ansi-green-fg ansi-bold">      1</span> <span style="font-style:italic;color:rgb(95,135,135)"># ...preceding code</span>
<span class="ansi-green-fg">----&gt; 2</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>args <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>parser<span style="color:rgb(98,98,98)">.</span>parse_args()
<span class="ansi-green-fg ansi-bold">      3</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>interval <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>args<span style="color:rgb(98,98,98)">.</span>duration <span style="color:rgb(98,98,98)">/</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>args<span style="color:rgb(98,98,98)">.</span>samples
<span class="ansi-green-fg ansi-bold">      4</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>currentDate <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">str</span>(datetime<span style="color:rgb(98,98,98)">.</span>datetime<span style="color:rgb(98,98,98)">.</span>today()<span style="color:rgb(98,98,98)">.</span>strftime(<span style="color:rgb(175,0,0)">'</span><span style="font-weight:bold;color:rgb(175,95,135)">%d</span><span style="color:rgb(175,0,0)">-</span><span style="color:rgb(175,0,0)">%</span><span style="color:rgb(175,0,0)">m-</span><span style="color:rgb(175,0,0)">%</span><span style="color:rgb(175,0,0)">Y</span><span style="color:rgb(175,0,0)">'</span>))

<span class="ansi-red-fg">NameError</span>: name 'self' is not defined</pre>
</div>
</div>
</div>
<p><em>Listing 4</em>: Declaration of class members ‘args’, ‘interval’, ‘currentDate’, and ‘saveLoc’.</p>
<p>The first if statement in <em>Listing 5</em> checks if the path specified in the CLI exists, and if it does not, it creates it using the os library.</p>
<p>The second if statement checks if the path stored in ‘self.saveLoc’ exists. Note that self.saveLoc and the arguments passed to os.path.exists ‘self.args.path’, “/”, self.currentDate are the same. <strong>I will modify the second if statement so that it simply takes self.saveLoc as an argument for simplicity and consistency.</strong></p>
<div id="e5253d07" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ...preceding code</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="va">self</span>.args.path):</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>            os.makedirs(<span class="va">self</span>.args.path)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="va">self</span>.args.path <span class="op">+</span> <span class="st">"/"</span> <span class="op">+</span> <span class="va">self</span>.currentDate):</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If current date directory does not exist in specified save file path, create it</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>            os.makedirs(<span class="va">self</span>.saveLoc)  </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># rest of code...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[21], line 2</span>
<span class="ansi-green-fg ansi-bold">      1</span> <span style="font-style:italic;color:rgb(95,135,135)"># ...preceding code</span>
<span class="ansi-green-fg">----&gt; 2</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> os<span style="color:rgb(98,98,98)">.</span>path<span style="color:rgb(98,98,98)">.</span>exists(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>args<span style="color:rgb(98,98,98)">.</span>path):
<span class="ansi-green-fg ansi-bold">      3</span>     os<span style="color:rgb(98,98,98)">.</span>makedirs(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>args<span style="color:rgb(98,98,98)">.</span>path)
<span class="ansi-green-fg ansi-bold">      5</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> os<span style="color:rgb(98,98,98)">.</span>path<span style="color:rgb(98,98,98)">.</span>exists(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>args<span style="color:rgb(98,98,98)">.</span>path <span style="color:rgb(98,98,98)">+</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">/</span><span style="color:rgb(175,0,0)">"</span> <span style="color:rgb(98,98,98)">+</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>currentDate):
<span class="ansi-green-fg ansi-bold">      6</span>     <span style="font-style:italic;color:rgb(95,135,135)"># If current date directory does not exist in specified save file path, create it</span>

<span class="ansi-red-fg">NameError</span>: name 'os' is not defined</pre>
</div>
</div>
</div>
<p><em>Listing 6</em> underpins one of the more significant changes I could make to the programme so far. The programme is organised into files, where each file defines a class, each class an implementation of some components of the system. I previously described ‘main.py’ as a control centre/root, and in (map.md) these files are shown as siblings to this root. As seen in <em>Listing 6</em>, the CameraController object is passed a member from the ImagingSystem class (‘self.saveLoc’). In this way, the camera class is dependent on the ImagingSystem class, but this isn’t explicit in the code. It would make more sense within an OOP paradigm to define CameraController as a child class of ImagingSystem. This way, CameraController instances could access Protected and Public members of ImagingSystem (for example, ImagingSystem.saveLoc) without the need to pass ImagingSystem.saveLoc as a parameter to the CameraController constructor. With this said, it might be overkill as it is now given only one member is being passed - but as you will see in <em>Listing 7</em>, the two classes continue to interact.</p>
<div id="555513af" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ...preceding code</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.cameraController <span class="op">=</span> CameraController(<span class="va">self</span>.saveLoc) <span class="co"># configures camera module</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lightController <span class="op">=</span> NeopixelController()</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.motorController <span class="op">=</span> MotorController()</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># end of class contructor.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[22], line 2</span>
<span class="ansi-green-fg ansi-bold">      1</span> <span style="font-style:italic;color:rgb(95,135,135)"># ...preceding code</span>
<span class="ansi-green-fg">----&gt; 2</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>cameraController <span style="color:rgb(98,98,98)">=</span> CameraController(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>saveLoc) <span style="font-style:italic;color:rgb(95,135,135)"># configures camera module</span>
<span class="ansi-green-fg ansi-bold">      3</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lightController <span style="color:rgb(98,98,98)">=</span> NeopixelController()
<span class="ansi-green-fg ansi-bold">      4</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>motorController <span style="color:rgb(98,98,98)">=</span> MotorController()

<span class="ansi-red-fg">NameError</span>: name 'CameraController' is not defined</pre>
</div>
</div>
</div>
<p><em>Listing 6</em> instantiating 3 sibling objects: cameraController, lightController, and motorController.</p>
<p><em>Listing 7</em> forms the timelapse function of the ImagingSystem. It uses a for loop, where the call to range() on self.args.samples returns integers from 0 (this is the default) to whatever the samples CLI input is. Then, the neopixel light object calls the on() method to turn on the light. The print statement uses a string literal to print the progress of the timelapse to standard out. The cameraController object calls its capture_image() method which takes the (timepoint + 1) as an argument - this is used to save the image using methods from the picamera module under (this prevents the next image from being overwritten on the next iteration). After the imaging itself is handled by the cameraController, the light is turned off, and the programme pauses using sleep() based on the time interval between images calculated in <em>Listing 4</em>. After all the imges have been taken, a call to the cleanup() method of the ImagingSystem class is made.</p>
<div id="2083b23c" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> timelapse(<span class="va">self</span>):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> timepoint <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.args.samples):</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.lightController.on()</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Taking image </span><span class="sc">{</span>timepoint<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.cameraController.capture_image(timepoint<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.lightController.off()</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>            time.sleep(<span class="va">self</span>.interval)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.cleanup()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><em>Listing 7</em> the timelapse method of the ImagingSystem class.</p>
<p><em>Listing 8</em> shows the cleanup() method. Firstly, a string is printed to standard out. Then the stop() method of the picam2 library is called, as per the <a href="https://datasheets.raspberrypi.com/camera/picamera2-manual.pdf">documentation</a>. The exit() method of sys library terminates the program, where 0 indicates successful termination (not necessary, but nice for clarity to show this is the intended point for the programme to terminate).</p>
<div id="30126331" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> cleanup(<span class="va">self</span>):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Timelapse is complete. Now exiting."</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.cameraController.picam2.stop()</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>            sys.exit(<span class="dv">0</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># main body as in Listing 2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><em>Listing 8</em> cleanup method of the ImagingSystem class.</p>
<p><strong>Usage Example (36hr timelapse, 1 image/hr):</strong></p>
<pre class="{bash}"><code>raspberrypi@raspberrypi:~/Desktop $ cd SC_TSL_06082024_Imaging-System/
raspberrypi@raspberrypi:~/Desktop/SC_TSL_06082024_Imaging-System $ ls
Archive  camera  GoHREPs  images  Jupyter_Notebooks  Physical_System_Design  README.md  src
raspberrypi@raspberrypi:~/Desktop/SC_TSL_06082024_Imaging-System $ source camera/bin/activate
(camera) raspberrypi@raspberrypi:~/Desktop/SC_TSL_06082024_Imaging-System $ sudo camera/bin/python3 src/main.py -t -u s -d 129600 -s 36 -p ~/Desktop/36_hr_weekend_test
[2:18:52.883082236] [2401]  INFO Camera camera_manager.cpp:313 libcamera v0.3.0+65-6ddd79b5
[2:18:52.927986121] [2408]  WARN RPiSdn sdn.cpp:40 Using legacy SDN tuning - please consider moving SDN inside rpi.denoise
[2:18:52.929969699] [2408]  INFO RPI vc4.cpp:446 Registered camera /base/soc/i2c0mux/i2c@1/imx519@1a to Unicam device /dev/media4 and ISP device /dev/media0
[2:18:52.930040420] [2408]  INFO RPI pipeline_base.cpp:1104 Using configuration file '/usr/share/libcamera/pipeline/rpi/vc4/rpi_apps.yaml'
[2:18:52.932840633] [2401]  INFO Camera camera_manager.cpp:313 libcamera v0.3.0+65-6ddd79b5
[2:18:52.973214055] [2413]  WARN RPiSdn sdn.cpp:40 Using legacy SDN tuning - please consider moving SDN inside rpi.denoise
[2:18:52.975601719] [2413]  INFO RPI vc4.cpp:446 Registered camera /base/soc/i2c0mux/i2c@1/imx519@1a to Unicam device /dev/media4 and ISP device /dev/media0
[2:18:52.975708125] [2413]  INFO RPI pipeline_base.cpp:1104 Using configuration file '/usr/share/libcamera/pipeline/rpi/vc4/rpi_apps.yaml'
{'format': 'BGR888', 'size': (4656, 3496)}
[2:18:52.983595401] [2401]  INFO Camera camera.cpp:1183 configuring streams: (0) 4656x3496-BGR888 (1) 4656x3496-SRGGB10_CSI2P
[2:18:52.984159299] [2413]  INFO RPI vc4.cpp:621 Sensor: /base/soc/i2c0mux/i2c@1/imx519@1a - Selected sensor format: 4656x3496-SRGGB10_1X10 - Selected unicam format: 4656x3496-pRAA
Taking image 1
Taking image 2
Taking image 3
Taking image 4
Taking image 5
Taking image 6
Taking image 7
Taking image 8
Taking image 9
Taking image 10
Taking image 11
Taking image 12
Taking image 13
Taking image 14
Taking image 15
Taking image 16
Taking image 17
Taking image 18
Taking image 19
Taking image 20
Taking image 21
Taking image 22
Taking image 23
Taking image 24
Taking image 25
Taking image 26
Taking image 27
Taking image 28
Taking image 29
Taking image 30
Taking image 31
Taking image 32
Taking image 33
Taking image 34
Taking image 35
Taking image 36
Timelapse is complete. Now exiting.</code></pre>
<p><strong>Images at specified path:</strong></p>
<pre class="{bash}"><code>(camera) raspberrypi@raspberrypi:~/Desktop $ ls 36_hr_weekend_test/06-09-2024/
10.png  12.png  14.png  16.png  18.png  1.png   21.png  23.png  25.png  27.png  29.png  30.png  32.png  34.png  36.png  4.png  6.png  8.png
11.png  13.png  15.png  17.png  19.png  20.png  22.png  24.png  26.png  28.png  2.png   31.png  33.png  35.png  3.png   5.png  7.png  9.png
(camera) raspberrypi@raspberrypi:~/Desktop $ </code></pre>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>